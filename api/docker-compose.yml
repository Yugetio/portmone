version: '3'

volumes:
  elasticsearch:

services:

### Composer ##############################################
    composer:
      image: composer:latest
      volumes:
      - .:/app
      command: 'true'

### PHP-FPM ##############################################
    php-fpm:
      build:
        context: ./docker/php-fpm
      volumes:
        - ./docker/php-fpm/php.ini:/usr/local/etc/php/php.ini
        - ./:/var/www
      expose:
        - "9000"

### NGINX Server #########################################
    nginx:
      build:
        context: ./docker/nginx
      volumes:
        - ./:/var/www
      ports:
        - 8080:80
        - 8442:443
      depends_on:
        - php-fpm

#### PostgreSQL ###########################################
    postgres:
      build: ./docker/postgres
      volumes:
        - ./docker/postgres/entrypoint-initdb.d:/docker-entrypoint-initdb.d
      ports:
        - "5432:5432"

#### ElasticSearch ########################################
    elasticsearch:
      build: ./docker/elasticsearch
      volumes:
        - elasticsearch:/usr/share/elasticsearch/data
      environment:
        - cluster.name=portmone
        - bootstrap.memory_lock=true
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      ulimits:
        memlock:
          soft: -1
          hard: -1
      ports:
        - "9200:9200"
        - "9300:9300"
      depends_on:
        - php-fpm